<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="API Documentation" href="../api.html" /><link rel="prev" title="Configuration of Indexing and Search" href="configuration_of_indexing_and_search.html" />

    <meta name="generator" content="sphinx-4.4.0, furo 2022.03.04"/>
        <title>Storage Backends - narrow-down 0.8.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=935aa2abcc5c1da4283d1dc201fb1f0add16d23a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=25ceb02ed1c46dc30f2321ff83e92799f69dfdb9" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">narrow-down 0.8.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">narrow-down 0.8.0</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Narrow Down - Efficient near-duplicate search</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration_of_indexing_and_search.html">Configuration of Indexing and Search</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Storage Backends</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api.html">API Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../narrow_down.html">narrow_down package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/narrow_down.hash.html">narrow_down.hash module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/narrow_down.scylladb.html">narrow_down.scylladb module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/narrow_down.similarity_store.html">narrow_down.similarity_store module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/narrow_down.sqlite.html">narrow_down.sqlite module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/narrow_down.storage.html">narrow_down.storage module</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">Apache Software License 2.0</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="storage-backends">
<h1>Storage Backends<a class="headerlink" href="#storage-backends" title="Permalink to this headline">#</a></h1>
<p>Narrow-down is based on a flexible storage abstraction. The common interface is the abstract class <a class="reference internal" href="../apidoc/narrow_down.storage.html#narrow_down.storage.StorageBackend" title="narrow_down.storage.StorageBackend"><span class="xref myst py py-class">StorageBackend</span></a>. Per default, a new <a class="reference internal" href="../apidoc/narrow_down.similarity_store.html#narrow_down.similarity_store.SimilarityStore" title="narrow_down.similarity_store.SimilarityStore"><span class="xref myst py py-class">SimilarityStore</span></a> object starts with an empty index and uses in-memory storage. The lifetime of the index is bound to the lifetime of the SimilarityStore object in this case. This can be changed by explicitly specifying a storage backend.</p>
<p>The following backends are built in:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#inmemorystore"><span class="std std-doc">InMemoryStore</span></a></p></li>
<li><p><a class="reference internal" href="#scylladb-or-cassandra"><span class="std std-doc">ScyllaDBStore</span></a> (for ScyllaDB or Cassandra)</p></li>
<li><p><a class="reference internal" href="#sqlite"><span class="std std-doc">SQLiteStore</span></a></p></li>
</ul>
<section id="using-storage-backends">
<h2>Using storage backends<a class="headerlink" href="#using-storage-backends" title="Permalink to this headline">#</a></h2>
<section id="explicitly-specifying-a-storage-backend">
<h3>Explicitly specifying a storage backend<a class="headerlink" href="#explicitly-specifying-a-storage-backend" title="Permalink to this headline">#</a></h3>
<p>A storage backend can be explicitly defined and handed over to a SimilarityStore object. For this it can be specified as argument to the <a class="reference internal" href="../apidoc/narrow_down.similarity_store.html#narrow_down.similarity_store.SimilarityStore.create" title="narrow_down.similarity_store.SimilarityStore.create"><span class="xref myst py py-meth">create</span></a> method. It takes care of initializing the backend, e.g. by creating the necessary database tables:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">narrow_down.similarity_store</span> <span class="kn">import</span> <span class="n">SimilarityStore</span>
<span class="kn">from</span> <span class="nn">narrow_down.storage</span> <span class="kn">import</span> <span class="n">InMemoryStore</span>

<span class="n">storage_backend</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">()</span>

<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="loading-similaritystore-from-storage">
<h3>Loading SimilarityStore from storage<a class="headerlink" href="#loading-similaritystore-from-storage" title="Permalink to this headline">#</a></h3>
<p>All the settings of a <code class="docutils literal notranslate"><span class="pre">SimilarityStore</span></code> object are also persisted in the storage backend. Therefore one can re-create a <code class="docutils literal notranslate"><span class="pre">SimilarityStore</span></code> from the storage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">load_from_storage</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="storeddocument">
<h3>StoredDocument<a class="headerlink" href="#storeddocument" title="Permalink to this headline">#</a></h3>
<p>The documents are represented in storage as <a class="reference internal" href="../apidoc/narrow_down.storage.html#narrow_down.storage.StoredDocument" title="narrow_down.storage.StoredDocument"><span class="xref myst py py-class">StoredDocument</span></a>
objects. This is a simple dataclass with the following attributes:</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-left head"><p></p></th>
<th class="text-left head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>id_</p></td>
<td class="text-left"><p>Unique identifier</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>document</p></td>
<td class="text-left"><p>The actual text to use for fuzzy matching</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>exact_part</p></td>
<td class="text-left"><p>An optional string which should be matched exactly</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>data</p></td>
<td class="text-left"><p>Payload to persist together with the document</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>fingerprint</p></td>
<td class="text-left"><p>A fuzzy fingerprint of the document, e.g. a Minhash</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>`</p></td>
<td class="text-left"><p></p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>The <code class="docutils literal notranslate"><span class="pre">id_</span></code> can be either generated or specified by the user. The attributes <code class="docutils literal notranslate"><span class="pre">document</span></code>, <code class="docutils literal notranslate"><span class="pre">exact_part</span></code> and <code class="docutils literal notranslate"><span class="pre">data</span></code> are user specified input. Only the first two are used for searching, the <code class="docutils literal notranslate"><span class="pre">data</span></code> is some optional payload that can be stored together with the rest.</p></td>
<td class="text-left"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">fingerprint</span></code> finally, is mostly of internal value. This is calculated from the input data on indexing.</p></td>
<td class="text-left"><p></p></td>
</tr>
</tbody>
</table></div>
<p>A <code class="docutils literal notranslate"><span class="pre">StoredDocument</span></code> is also the kind of object which is returned as search result.</p>
</section>
<section id="storage-levels">
<h3>Storage levels<a class="headerlink" href="#storage-levels" title="Permalink to this headline">#</a></h3>
<p>Depending on the usecase, different levels of persistence may be preferable. Sometimes it is enough to only store just enough to be able to get the IDs of matching documents. In other cases, it can be better to store the whole documents or some additional data in the index. This way it is not necessary to have a second database for this data.</p>
<p>The available storage levels as defined in the enum <a class="reference internal" href="../apidoc/narrow_down.storage.html#narrow_down.storage.StorageLevel" title="narrow_down.storage.StorageLevel"><span class="xref myst py py-class">StorageLevel</span></a> are:</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-left head"><p>Storage level</p></th>
<th class="text-left head"><p>Effect</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>Minimal</p></td>
<td class="text-left"><p>Minimal storage level.<br/>Only store the necessary data to perform the search, namely only the “id” and (if given) the “data”.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Fingerprint</p></td>
<td class="text-left"><p>Store in addition to “Minimal” also the “fingerprint” attribute.</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Document</p></td>
<td class="text-left"><p>Store in addition to “Minimal” also the “document” and the “exact_part” attributes.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Full</p></td>
<td class="text-left"><p>Stores all attributes of the “StoredDocument”.</p></td>
</tr>
</tbody>
</table></div>
<p>The example below shows how to set and use the storage levels with a SimilarityStore.</p>
<p>With “Minimal” (the default value), we only get the id and data out as query result. All other attributes are <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">storage_backend</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">()</span>

<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">)</span>

<span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">"additional data"</span>
<span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">)</span>
<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>StoredDocument(id_=1, document=None, exact_part=None, fingerprint=None, data='additional data')
</pre></div>
</div>
<p>If we use the storage level “Document” instead, also the document and exact_part attributes are stored and retrieved:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">narrow_down.storage</span> <span class="kn">import</span> <span class="n">StorageLevel</span>

<span class="n">storage_backend</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">()</span>

<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">,</span> <span class="n">storage_level</span><span class="o">=</span><span class="n">StorageLevel</span><span class="o">.</span><span class="n">Document</span>
<span class="p">)</span>

<span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">"additional data"</span>
<span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">)</span>
<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>StoredDocument(id_=1, document='the document text', exact_part='the exact part', fingerprint=None, data='additional data')
</pre></div>
</div>
<p><em>Note: The storage level needs to be defined when creating a <code class="docutils literal notranslate"><span class="pre">SimilarityStore</span></code> and cannot be changed later</em></p>
</section>
</section>
<section id="inmemorystore">
<h2>InMemoryStore<a class="headerlink" href="#inmemorystore" title="Permalink to this headline">#</a></h2>
<p>The simplest backend and also the fastest both for indexing and querying is
<a class="reference internal" href="../apidoc/narrow_down.storage.html#narrow_down.storage.InMemoryStore" title="narrow_down.storage.InMemoryStore"><span class="xref myst py py-class">InMemoryStore</span></a>. It stores all data in in-memory data structures. Therefore it is only accessible within the process which holds the memory. But it also offers a way to persist the data to disk. It can be serialized into a file in efficient binary MessagePack format.</p>
<p>Advantages:</p>
<ul class="simple">
<li><p>Fastest backend</p></li>
<li><p>Easy setup</p></li>
</ul>
<p>Disadvantages:</p>
<ul class="simple">
<li><p>Data size is limited by the physical memory</p></li>
<li><p>Only one process can access the data for writing at the same time</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize and use:</span>
<span class="n">storage_backend</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">()</span>
<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">,</span> <span class="n">storage_level</span><span class="o">=</span><span class="n">StorageLevel</span><span class="o">.</span><span class="n">Document</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">"additional data"</span>
<span class="p">)</span>

<span class="c1"># Store to a file:</span>
<span class="n">storage_backend</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">"/tmp/storage-backend.msgpack"</span><span class="p">)</span>

<span class="c1"># Load again:</span>
<span class="n">storage_backend</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s2">"/tmp/storage-backend.msgpack"</span><span class="p">)</span>
<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">load_from_storage</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">)</span>
<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>StoredDocument(id_=1, document='the document text', exact_part='the exact part', fingerprint=None, data='additional data')
</pre></div>
</div>
</section>
<section id="scylladb-or-cassandra">
<h2>ScyllaDB or Cassandra<a class="headerlink" href="#scylladb-or-cassandra" title="Permalink to this headline">#</a></h2>
<p>With access to <a class="reference external" href="https://cassandra.apache.org">Apache Cassandra</a> or <a class="reference external" href="https://www.scylladb.com/">ScyllaDB</a> (a reimplementation of Cassandra in C++), it is possible to use Narrow-down in a distributed system and beyond the boundaries of a single system’s memory.</p>
<p>See the API documentation of <a class="reference internal" href="../apidoc/narrow_down.scylladb.html#narrow_down.scylladb.ScyllaDBStore" title="narrow_down.scylladb.ScyllaDBStore"><span class="xref myst py py-class">ScyllaDBStore</span></a> for more details.</p>
<p>Advantages:</p>
<ul class="simple">
<li><p>Can be used across multiple processes or services</p></li>
<li><p>Low memory footprint for the application</p></li>
<li><p>Asynchronous implementation allows concurrent usage</p></li>
</ul>
<p>Disadvantages:</p>
<ul class="simple">
<li><p>Database server needed</p></li>
<li><p>Slower than in-memory storage</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cassandra</span>

<span class="kn">from</span> <span class="nn">narrow_down.scylladb</span> <span class="kn">import</span> <span class="n">ScyllaDBStore</span>

<span class="n">cassandra_cluster</span> <span class="o">=</span> <span class="n">cassandra</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span><span class="n">contact_points</span><span class="o">=</span><span class="p">[</span><span class="s2">"localhost"</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="mi">9042</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">cassandra_cluster</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">"CREATE KEYSPACE IF NOT EXISTS test_ks "</span>
    <span class="s2">"WITH replication = {'class': 'SimpleStrategy', 'replication_factor' : 1} "</span>
    <span class="s2">"AND durable_writes = False"</span>
<span class="p">)</span>

<span class="n">cassandra_storage</span> <span class="o">=</span> <span class="n">ScyllaDBStore</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">keyspace</span><span class="o">=</span><span class="s2">"test_ks"</span><span class="p">)</span>

<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">cassandra_storage</span><span class="p">)</span>
</pre></div>
</div>
<p>So the actual connection is created and managed outside of narrow_down and is passed to it.
After first initialization of the database one should not use the <code class="docutils literal notranslate"><span class="pre">create()</span></code> method anymore, but rather the <code class="docutils literal notranslate"><span class="pre">load_from_storage()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">load_from_storage</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">cassandra_storage</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sqlite">
<h2>SQLite<a class="headerlink" href="#sqlite" title="Permalink to this headline">#</a></h2>
<p>Narrow-Down also supports using a local <a class="reference external" href="https://www.sqlite.org">SQLite</a> database as storage backend. This offers a simple setup for an amount of data which exceeds memory limit. It is fairly fast on Linux, leveraging the file system’s write cache. On Windows indexing is very slow, because every commit operation is directly flushed to disk.</p>
<p>Configuration options are documentend in the API documentation of <a class="reference internal" href="../apidoc/narrow_down.sqlite.html#narrow_down.sqlite.SQLiteStore" title="narrow_down.sqlite.SQLiteStore"><span class="xref myst py py-class">SQLiteStore</span></a>.</p>
<p>Advantages:</p>
<ul class="simple">
<li><p>Low memory footprint for the application</p></li>
<li><p>Easy setup without external dependencies</p></li>
</ul>
<p>Disadvantages:</p>
<ul class="simple">
<li><p>Slow indexing, especially on Windows</p></li>
</ul>
<p>Usage example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">narrow_down.sqlite</span> <span class="kn">import</span> <span class="n">SQLiteStore</span>

<span class="c1"># Initialize and use:</span>
<span class="n">storage_backend</span> <span class="o">=</span> <span class="n">SQLiteStore</span><span class="p">(</span><span class="s2">"/tmp/storage-backend.sqlite"</span><span class="p">)</span>
<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">,</span> <span class="n">storage_level</span><span class="o">=</span><span class="n">StorageLevel</span><span class="o">.</span><span class="n">Document</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">"additional data"</span>
<span class="p">)</span>

<span class="c1"># Reopen and continue later:</span>
<span class="n">storage_backend</span> <span class="o">=</span> <span class="n">SQLiteStore</span><span class="p">(</span><span class="s2">"/tmp/storage-backend.sqlite"</span><span class="p">)</span>
<span class="n">similarity_store</span> <span class="o">=</span> <span class="k">await</span> <span class="n">SimilarityStore</span><span class="o">.</span><span class="n">load_from_storage</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">storage_backend</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">similarity_store</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="s2">"the document text"</span><span class="p">,</span> <span class="n">exact_part</span><span class="o">=</span><span class="s2">"the exact part"</span><span class="p">)</span>
<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>StoredDocument(id_=1, document='the document text', exact_part='the exact part', fingerprint=None, data='additional data')
</pre></div>
</div>
</section>
<section id="custom-backend">
<h2>Custom backend<a class="headerlink" href="#custom-backend" title="Permalink to this headline">#</a></h2>
<p>Narrow-down is designed to make it easy to implement storage backend. This allows to plug-in a custom backend which for example use a database which is not supported out-of-the-box.</p>
<p>In order to do so, create a class which inherits from the abstract <a class="reference internal" href="../apidoc/narrow_down.storage.html#narrow_down.storage.StorageBackend" title="narrow_down.storage.StorageBackend"><span class="xref myst py py-class">StorageBackend</span></a> class and implement the methods. The implementation of the built-in backends can serve as examples.</p>
<p>Advantages:</p>
<ul class="simple">
<li><p>Also unsupported databases can be used</p></li>
</ul>
<p>Disadvantages:</p>
<ul class="simple">
<li><p>Some implementation effort (typically 100-200 lines of code)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../api.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">API Documentation</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="configuration_of_indexing_and_search.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Configuration of Indexing and Search</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Christian Krudewig
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Storage Backends</a><ul>
<li><a class="reference internal" href="#using-storage-backends">Using storage backends</a><ul>
<li><a class="reference internal" href="#explicitly-specifying-a-storage-backend">Explicitly specifying a storage backend</a></li>
<li><a class="reference internal" href="#loading-similaritystore-from-storage">Loading SimilarityStore from storage</a></li>
<li><a class="reference internal" href="#storeddocument">StoredDocument</a></li>
<li><a class="reference internal" href="#storage-levels">Storage levels</a></li>
</ul>
</li>
<li><a class="reference internal" href="#inmemorystore">InMemoryStore</a></li>
<li><a class="reference internal" href="#scylladb-or-cassandra">ScyllaDB or Cassandra</a></li>
<li><a class="reference internal" href="#sqlite">SQLite</a></li>
<li><a class="reference internal" href="#custom-backend">Custom backend</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    </body>
</html>